<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script async src="//acdn.adnxs.com/prebid/not-for-prod/1/prebid.js"></script>
    <link href="//players.brightcove.net/videojs-ima3/3/videojs.ima3.min.css" rel="stylesheet">
    <title>Prebid Video -- Brightcove Player</title>
  </head>
  <body>
    <h1>Prebid Video -- Brightcove Player</h1>

    <video id="myVideo"
      data-account="3450462642001"
      data-player="rJeCmGYZWm"
      data-video-id="5249150135001"
      data-embed="default"
      data-application-id
      class="video-js"
      playsinline
      controls
      width="640"
      height="480">
    </video>
    <script src="//players.brightcove.net/3450462642001/rJeCmGYZWm_default/index.min.js"></script>
    <script src="//players.brightcove.net/videojs-ima3/3/videojs.ima3.min.js"></script>

    <script type="text/JavaScript">
      var pbjs = pbjs || {};
      pbjs.que = pbjs.que || [];
      iosDevice = !!navigator.platform.match(/iPhone|iPod|iPad/);

      //function invokeVideoPlayer(url) {
        var getServerUrl = function(callback) {
          var videoAdUnit = {
            code: 'video1',
            mediaTypes: {
              video: {
                playerSize: [640, 480],
                context: 'instream'
              }
            },
            bids: [{
              bidder: 'appnexus',
              params: {
                placementId: iosDevice ? 13239390 : 13232361, // Add your own placement id here. Note, skippable video is not supported on iOS
                video: {
                  skipppable: true,
                  playback_method: ['auto_play_sound_off']
                }
              }
            }]
          };

          pbjs.que.push(function() {
            pbjs.addAdUnits(videoAdUnit);
            pbjs.setConfig({
              debug: true,
              cache: {
                url: 'https://prebid.adnxs.com/pbc/v1/cache'
              }
            });
            pbjs.requestBids({
              bidsBackHandler: function(bids) {
                var videoUrl = pbjs.adServers.dfp.buildVideoUrl({
                  adUnit: videoAdUnit,
                  params: {
                    iu: '/19968336/prebid_cache_video_adunit',
                    cust_params: {
                      section: 'blog',
                      anotherKey: 'anotherValue'
                    },
                    output: 'vast'
                  }
                });
              callback (videoUrl);
              }
            });
          });
        };

          // USE `bc()` TO REFERENCE VIDEO PLAYER, PASS OPTIONS INTO IMA3 PLUGIN
        bc("myVideo").ima3({
          serverUrl: getServerUrl,
          debug: true,
          timeout: 5000,
          ima3SdkSettings: {
            "disableCustomPlaybackForIOS10Plus": true
          },
          adTechOrder: [
            "html5",
            "flash"
            ],
        });

        // ADD A `ready` LISTENER AND INTERACT WITH THE PLAYER

        //   Call `videojs()` and pass in the ID of the video element to
        //   get a reference to the player. Call `.ready` on the player
        //   to set up the event listener, and place any code that will
        //   interact with the player inside the callback (such as
        //   loading media files, logging events for the player or ads).

       videojs("myVideo").ready(function() {
           var myPlayer = this;

          // LOAD THE MEDIA FILE

          //   Once we know the player is ready and we have our prebid ad
          //   ready, load the content video from Brightcove Studio.

          //   Replace this ID with the ID with one of your own media file IDs
          //   which can be found in your Brightcove Studio account.

//         myPlayer.catalog.getVideo("5249150135001", function(error, video){
//          myPlayer.catalog.load(video);
//          if(error) {
//              console.log("There was an error retrieving the media file: " + error);
//          }
//          });

          myPlayer.on("ima3error", function() {
          console.log("There was an ima3 error.");
          });
      });
    //   };

      // ACCOUNT FOR PAGE SPEED

      //   If prebid returned bids before the browser reached the end of
      //   the page, the first version of `invokeVideoPlayer` will have
      //   been called from `bidsBackHandler` so the winning vast tag
      //   will be stored in `tempTag`.

      //   If that's the case, we want to call the 'real' version of
      //   `invokeVideoPlayer` with the stored url to create the player
      //   and play the ad.

      //   If `tempTag` is not defined, that means the browser reached
      //   the end of the page before the bids came back from prebid,
      //   meaning the 'real' version of `invokeVideoPlayer` was already
      //   called.

//      if (tempTag) {
//         invokeVideoPlayer(tempTag);
//         tempTag = false;
//      }
      </script>

  </body>

</html>
