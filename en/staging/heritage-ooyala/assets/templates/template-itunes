<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:media="http://search.yahoo.com/mrss/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd" version="2.0">
  <channel>
    {%- if title %}
    <title>{{title | escape}}</title>
    {%- else %}
    <title>{{name | escape}}</title>
    {%- endif %}

    {%- if description %}
    <description>{{description | escape}}</description>
    {%- else %}
    <description>{{name | escape}}</description>
    {%- endif %}

    {%- if destination_url %}
    <link>{{destination_url | escape}}</link>
    {%- elsif syndication_url %}
    <link>{{syndication_url | escape}}</link>
    {%- endif %}

    {%- if owner_name or owner_email %}
    <itunes:owner>
      {%- if owner_name %}
      <itunes:name>{{owner_name | escape}}</itunes:name>
      {%- endif %}
      {%- if owner_email%}
      <itunes:email>{{owner_email | escape}}</itunes:email>
      {%- endif %}
    </itunes:owner>
    {%- endif %}

    {%- if language %}
    <language>{{language | escape}}</language>
    {%- endif %}

    {%- if author %}
    <itunes:author>{{author | escape}}</itunes:author>
    {%- endif %}

    {%- if keywords %}
    <itunes:keywords>{{keywords | escape}}</itunes:keywords>
    {%- endif %}

    {%- if subtitle %}
    <itunes:subtitle>{{subtitle | escape}}</itunes:subtitle>
    {%- endif %}

    {%- if description %}
    <itunes:summary>{{description | escape}}</itunes:summary>
    {%- endif %}

    {%- if category %}
    {%- assign categories = category | split: ":" %}
    {%- if categories.size == 1 %}
    <itunes:category text="{{category | escape}}"></itunes:category>
    {%- elsif categories.size > 1 %}
    <itunes:category text="{{categories[0] | escape}}">
      <itunes:category text="{{categories[1] | escape}}"/>
    </itunes:category>
    {%- endif %}
    {%- endif %}

    {%- if explicit %}
    <itunes:explicit>{{explicit}}</itunes:explicit>
    {%- endif %}

    {%- comment %} Fall back to first asset's poster image if no album_art_url {% endcomment %}
    {%- if album_art_url %}
    <itunes:image href="{{album_art_url | escape}}"/>
    {%- elsif assets.size > 0 and assets[0].images.poster.sources.size > 0  %}
    <itunes:image href="{{assets[0].images.poster.sources[0].src | escape}}"/>
    {%- endif %}

    {%- for asset in assets %}
    <item>

      {%- if asset.name %}
      <title>{{asset.name | escape}}</title>
      {%- endif %}

      {%- if asset.description %}
      <description>{{asset.description | escape}}</description>
      {%- endif %}

      {%- if asset.id %}
      <guid isPermaLink="false">{{account_id}}:{{asset.id}}</guid>
      <link>{{player_url}}/{{account_id}}/default_default/index.html?videoId={{asset.id}}</link>
      {%- endif %}

      {%- if asset.publication_date %}
      <pubDate>{{asset.publication_date | date: "%a, %d %b %Y %H:%M:%S +0000"}}</pubDate>
      {%- else %}
      <pubDate>{{asset.created_at | date: "%a, %d %b %Y %H:%M:%S +0000"}}</pubDate>
      {%- endif %}

      {%- if asset.name %}
      <media:title>{{asset.name | escape}}</media:title>
      {%- endif %}

      {%- if asset.description %}
      <media:description>{{asset.description | escape}}</media:description>
      {%- endif %}

      {%- if asset.schedule.starts_at or asset.created_at %}
      <dcterms:valid>
          {%- if asset.schedule.starts_at %}start={{asset.schedule.starts_at | date: "%Y-%m-%dT%H:%M+00:00"}};
          {%- else %}start={{asset.created_at | date: "%Y-%m-%dT%H:%M+00:00"}};{%- endif -%}
          {%- if asset.schedule.ends_at %}end={{asset.schedule.ends_at | date: "%Y-%m-%dT%H:%M+00:00"}};{%- endif -%}
          scheme=W3C-DTF</dcterms:valid>
      {%- endif %}

      {%- if asset.images.thumbnail.sources.size > 0 %}
      {%- assign thumb = asset.images.thumbnail.sources[0] %}
      <media:thumbnail url="{{thumb.src | escape}}" width="{{thumb.width}}" height="{{thumb.height}}"/>
      {%- endif %}

      {%- if asset.best_mp4_source %}
      {%- assign source = asset.best_mp4_source %}

      {%- if source.src %}
      <enclosure url="{{source.src | escape}}" type="video/mp4"
        {%- if source.size %} length="{{source.size}}" {%- endif %}/>
      {%- endif %}

      {%- if source.duration %}
      <itunes:duration>{{source.duration | divided_by: 1000}}</itunes:duration>
      {%- endif %}
      {%- endif %}

      {%- if author %}
      <itunes:author>{{author | escape}}</itunes:author>
      {%- endif %}

      {%- if asset.description %}
      <itunes:summary>{{asset.description | escape}}</itunes:summary>
      {%- endif %}
    </item>
    {%- endfor %}
  </channel>
</rss>

