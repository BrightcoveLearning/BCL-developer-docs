<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Begin Drupal Taxonomy Data -->
    <meta name="products" content="Video Cloud, Brightcove Player">
    <meta name="role" content="Device SDK Developer">
    <meta name="task" content="Develop with the Native SDKs">
    <meta name="topic" content="Troubleshooting/Error Handling">
    <meta name="sdk" content="iOS,tvOS,Android">
    <meta name="keywords" content="device,SDK,FAQ">
    <!-- End Drupal Taxonomy Data -->

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  	<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=device-width" />
    <meta name="robots" content="noindex">
  	<!-- change title to match the h1 heading -->
  	<title>Appending SSAI Query Parameters with the Native SDKs</title>

    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/foundation.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/normalize.css" />
    <link href="//fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700" rel="stylesheet" type="text/css">
    <script src="//use.edgefonts.net/source-code-pro.js"></script>
    <link rel="stylesheet" href="//learning-services-media.brightcove.com/doc-assets/js/prism/prism.css">
    <link rel="stylesheet" href="//docs.brightcove.com/en/styles/template-less/css/bcls-doc.css">
    <link rel="stylesheet" href="/en/styles/foundation-fixes.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/js/vendor/modernizr.js"></script>

</head>

<body>
	<!-- header navbar -->
	<div id="navWrapper" class="fixed"></div>
	<!-- breadcrumbs -->
	<nav id="breadCrumbWrapper" class="breadcrumbs show-for-medium-up"></nav>
	<!-- search -->
	<div id="searchModal" class="reveal-modal" data-reveal></div>
	<!-- content -->
	<div class="row">
		<div class="sidebar large-2 columns show-for-large-up">
			<div id="sidenav" class="side-nav"></div>
		</div>
		<div id="main" class="large-10 small-12 columns">
			<h1>Appending SSAI Query Parameters with the Native SDKs</h1>
      <aside class="bcls-aside bcls-aside--warning">This is a temporary STAGING document for review only. For the official Brightcove documentation site, go to <a href="https://support.brightcove.com/">support.brightcove.com</a></aside>
      <p>In this topic, you will learn how to append SSAI query parameters to your VMAP URLs with the Brightcove Native Player SDKs.</p>
      <!-- <aside class="bcls-aside bcls-aside--information">The content in this document applies to Video Cloud only.</aside> -->


	    <!-- BEGIN DRUPAL CONTENT -->

<article class="bcls-article">
<section class="bcls-section">
<h2 id="Overview">Overview</h2>

<p>The Native player SDKs do not perform client-side macro replacement, but you can manually append query string parameters for ad targeting with SSAI. Learn more about <a href="/node/17942#Ad_variables">VOD SSAI ad macros</a>.</p>

<p>
  To provide custom values through URL parameters appended to the VMAP URL, follow these steps:
</p>

<ol class="bcls-tasklist">
	<li>
    <p>
      With an SSAI ad configuration id, retrieve a video object from the Brightcove catalog (Playback API). Learn how to create an SSAI ad configuration with the <a href="/node/17942">Video Cloud SSAI Ad Config API</a>. A sample ad configuration looks like this:
    </p>
    <pre class="line-numbers"><code class="notranslate language-java">{
  &quot;name&quot;: &quot;SSAI VMAP Ad Server&quot;,
  &quot;vmap_response_namespace&quot;: &quot;bc&quot;,
  &quot;config_id&quot;: &quot;<span class="bcls-input">your ad config Id</span>&quot;,
  &quot;account_id&quot;: &quot;1752604059001&quot;,
  &quot;created_timestamp&quot;: &quot;2017-10-24T20:21:55.106488973Z&quot;,
  &quot;updated_timestamp&quot;: &quot;2017-10-26T14:26:22.161791419Z&quot;,
  &quot;ad_config&quot;: {
  	&quot;enable_ads&quot;: true,
  	&quot;expected_ad_response&quot;: &quot;dfp_vmap&quot;,
  	&quot;proxy_beacons_enabled&quot;: false,
  	&quot;template_url&quot;: {
  		&quot;template&quot;: &quot;https://solutions.brightcove.com/bcls/brightcove-player/vmap/simple-vmap.xml&quot;
  	}
  }
}</code></pre>
<aside class="bcls-aside bcls-aside--tip">The <code class="notranslate">template_url</code> property contains the ad URL.</aside>
  </li>
	<li>
    <p>
    In the jsonResponse from the call to the Playback API, examine the sources for the video object. Each source object will contain a VMAP property and a VMAP URL. Select and extract the VMAP URL.
    </p>
      <pre><code class="notranslate language-java">http://ssaiplayback.prod.boltdns.net/playback/once/v1/vmap/hls/v3/clear/3981276734001/
  b871a6b8-4b3e-4787-b176-aed923287d5a/477b1308-fc18-47a6-bb99-6cb9e2ff2040/
  content.vmap<span class="bcls-highlight">?bc_token=XXX</span></code></pre>
    <aside class="bcls-aside bcls-aside--tip">The only URL parameter on the VMAP URL will be the <code class="notranslate">bc_token</code>.</aside>
  </li>
  <li>
    <p>
      Letâ€™s say your ad URL looks like this:
    </p>
    <pre><code class="notranslate language-java">https://myad.com/ads?rule={{url.rule}}&id={{url.video.id}}</code></pre>
    <p>
      If your ad URL has the above ad macros, then you will add these query parameters to the VMAP URLs with the appropriate values.
    </p>

  </li>
	<li>
    <p>
      Append query parameters to the VMAP URL. In this example, the <code class="notranslate">{{url.rule}}</code> macro in the ad url is replaced with the value <code class="notranslate">discos-enabled</code>, and the <code class="notranslate">{{url.video_id}}</code> macro is replaced with the video id value.
    </p>
    <pre><code class="notranslate language-java">http://ssaiplayback.prod.boltdns.net/playback/once/v1/vmap/hls/v3/clear/3981276734001/
b871a6b8-4b3e-4787-b176-aed923287d5a/477b1308-fc18-47a6-bb99-6cb9e2ff2040/
content.vmap<span class="bcls-highlight">?bc_token=XXX&rule=discos-enabled&video_id=5625751316001</span></code></pre>
  </li>
	<li>
    Process the video with the Once UX plugin.
  </li>
  <li>
    <p>
      For development details, see the following:
    </p>
    <ul>
      <li><a href="#Android_implementation">Android implementation</a></li>
      <li><a href="#iOS_implementation">iOS implementation</a></li>
    </ul>
  </li>
</ol>

</section>

<section class="bcls-section">
<h2 id="Android_implementation">Android implementation</h2>

<p>From the Playback API response, you can extract the appropriate VMAP source URL and append your query parameters. To do this, follow these steps:</p>

<ol class="bcls-tasklist__restart">
	<li>With an SSAI ad configuration id, retrieve a video object from the Brightcove catalog (Playback API). For details, see the <a href="/node/18364#Android_implementation">SSAI with the SDKs: Android implementation</a> document.</li>
  <li>
    <p>
      From the video object, select and extract the appropriate VMAP URL. Retrieve the default source using the <a href="https://docs.brightcove.com/android-sdk/javadoc/com/brightcove/onceux/OnceUxSourceSelectionController.html">OnceUxSourceSelectionController</a> object. The source object returned will have these properties:
    </p>
    <pre><code class="notranslate language-java">source.getProperties().get(Source.Fields.VMAP);</code></pre>
  </li>
  <li>
    Append query parameters to the VMAP URL.
  </li>
  <li>
    <p>
      Process the modified URL with the Once UX plugin as follows:
    </p>
    <pre><code class="notranslate language-java">plugin.processVideo(videoUrlString);</code></pre>
  </li>
</ol>
<!-- <p>
  Alternatively, you can select and extract the appropriate manifest URL as follows:
</p>
<pre><code class="notranslate language-java">source.getProperties().get(Source.Fields.URL);</code></pre>
<p>
  Once you append query parameters to the manifest URL, you can create the Video object and add it to the VideoView.
</p> -->

<!-- <h3 id="Android_MainActivity_file" class="bcls-expander-head">Android MainActivity file</h3>
<div class="bcls-expander-content">
<p>Your <strong>MainActivity.java</strong> file should look similar to this:</p>

<pre class="line-numbers">
<code class="notranslate language-java">package com.brightcove.player.samples.onceux.basic;

import android.os.Bundle;

}</code></pre>
</div>
&nbsp; -->
</section>

<section class="bcls-section">
<h2 id="iOS_implementation">iOS implementation</h2>

<p>From the Playback API response, you can extract the appropriate VMAP source URL and append your query parameters. To do this, follow these steps:</p>

<ol class="bcls-tasklist__restart">
	<li>With an SSAI ad configuration id, retrieve a video object from the Brightcove catalog (Playback API). For details, see the <a href="/node/18364#iOS_implementation">SSAI with the SDKs: iOS implementation</a> document.</li>
  <li>
    <p>
      From the video object, select and extract the appropriate manifest or VMAP URL. From the playback service response, the jsonResponse (NSDictionary) contains the <a href="https://docs.brightcove.com/ios-sdk/Classes/BCOVVideo.html">BCOVVideo</a> object, which includes the sources which hold the URL to the VMAP document. Your code may look similar to this:
    </p>
    <pre><code class="notranslate language-java">source.getProperties().get(Source.Fields.VMAP);</code></pre>
  </li>
  <li>
    Append query parameters to the VMAP URL.
  </li>
  <li>
    <p>
      Process the modified URL with the Once UX plugin as follows:
    </p>
    <pre class="line-numbers"><code class="notranslate language-java">- (void)playbackController:(id&lt;BCOVPlaybackController&gt;)controller didAdvanceToPlaybackSession:(id&lt;BCOVPlaybackSession&gt;)session
{
    NSLog(@&quot;ViewController Debug - Advanced to new session.&quot;);

    BCOVSource *currentSource = session.source;
    NSDictionary *propertiesDictionary = currentSource.properties;
    for (id key in propertiesDictionary)
    {
        if ([key isEqualToString:@&quot;vmap&quot;])
        {
            // do something to change the value
            NSLog(@&quot;key=%@ value=%@&quot;, key, [propertiesDictionary objectForKey:key]);
        }
    }
}</code></pre>
  </li>
  <li>
    Append query parameters to either the manifest or VMAP URL.
  </li>
  <li>
    <p>
      Process the modified URL with the Once UX plugin as follows:
    </p>
    <ol>
      <li>
        Create a <a href="https://docs.brightcove.com/ios-sdk/Classes/BCOVSource.html">BCOVSource</a> object using the <code class="notranslate">videoUrlString</code>
      </li>
      <li>
        Create the <a href="https://docs.brightcove.com/ios-sdk/Classes/BCOVVideo.html">BCOVVideo</a> object and <code class="notranslate">initWithSource:mySource</code>
      </li>
    </ol>
  </li>
</ol>



<h3 id="iOS_ViewController_using_Objective-C" class="bcls-expander-head">iOS ViewController using Objective-C</h3>
<div class="bcls-expander-content">
<p>Your <strong>ViewController.m</strong> file should look similar to this:</p>

<pre class="line-numbers">
<code class="notranslate language-objectivec">//
//  ViewController.m
//  SSAI Params
//
//  Copyright &copy; 2018 Brightcove. All rights reserved.
//

#import &quot;ViewController.h&quot;

@import BrightcovePlayerSDK;
@import BrightcoveOUX;

// ** Customize these values with your own account information **
static NSString * const kViewControllerPlaybackServicePolicyKey = @&quot;<span class="bcls-input">your policy key</span>&quot;;
static NSString * const kViewControllerAccountID = @&quot;<span class="bcls-input">your account id</span>&quot;;
static NSString * const kViewControllerVideoID = @&quot;<span class="bcls-input">your video id</span>&quot;;
static NSString * const kViewControllerAdConfigID = @&quot;<span class="bcls-input">your ad config id</span>&quot;;

@interface ViewController () &lt;BCOVPlaybackControllerDelegate&gt;

@property (nonatomic, strong) BCOVPlaybackService *playbackService;
@property (nonatomic, strong) id&lt;BCOVPlaybackController&gt; controller;
@property (nonatomic) BCOVPUIPlayerView *playerView;

@property (weak, nonatomic) IBOutlet UIView *videoContainerView;
@property (weak, nonatomic) IBOutlet UIView *companionSlotContainerView;
@property(copy) NSArray&lt;NSURLQueryItem *&gt; *queryItems;

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view, typically from a nib.

    BCOVPlayerSDKManager *manager = [BCOVPlayerSDKManager sharedManager];

    // Create a companion slot.
    BCOVOUXCompanionSlot *companionSlot = [[BCOVOUXCompanionSlot alloc] initWithView:self.companionSlotContainerView width:500 height:61];

    // In order to display an ad progress banner on the top of the view, we create this display container.  This object is also responsible for populating the companion slots.
    BCOVOUXAdComponentDisplayContainer *adComponentDisplayContainer = [[BCOVOUXAdComponentDisplayContainer alloc] initWithCompanionSlots:@[companionSlot]];

    self.controller = [manager createOUXPlaybackControllerWithViewStrategy:nil];

    // In order for the ad display container to receive ad information, we add it as a session consumer.
    [self.controller addSessionConsumer:adComponentDisplayContainer];

    self.controller.delegate = self;
    self.controller.autoPlay = YES;
    self.controller.autoAdvance = YES;

    BCOVPUIBasicControlView *controlView = [BCOVPUIBasicControlView basicControlViewWithVODLayout];
    // Set playback controller later.
    self.playerView = [[BCOVPUIPlayerView alloc] initWithPlaybackController:nil options:nil controlsView:controlView];
    self.playerView.frame = self.videoContainerView.bounds;
    self.playerView.autoresizingMask = UIViewAutoresizingFlexibleHeight | UIViewAutoresizingFlexibleWidth;
    [self.videoContainerView addSubview:self.playerView];

    self.playerView.playbackController = self.controller;

    _playbackService = [[BCOVPlaybackService alloc] initWithAccountId:kViewControllerAccountID
                      policyKey:kViewControllerPlaybackServicePolicyKey];
    [self requestContentFromPlaybackService];
}

- (void)requestContentFromPlaybackService
{
  // Set your SSAI ad configuration id as a query parameter
  NSDictionary *queryParameters = @{
                                    @&quot;ad_config_id&quot; : kViewControllerAdConfigID
                                    };
  // Retrieve a video from the Playback API using a video Id and your ad config Id
  [self.playbackService findVideoWithVideoID:kViewControllerVideoID parameters:queryParameters
    completion:^(BCOVVideo *video, NSDictionary *jsonResponse, NSError *error) {

    if (video)
    {
      // Create a mutable version of the jsonResponse NSDictionary object
      NSURLComponents *components = [[NSURLComponents alloc] init];
      NSMutableDictionary *videoPropertiesDictionary = [[NSMutableDictionary alloc] init];
      NSMutableArray *updatedSources = [[NSMutableArray alloc] init];

      // Define the URL parameters that will be added to the VMAP URL
      NSURLQueryItem *queryItemEntrypointUrlParameter = [NSURLQueryItem queryItemWithName:@&quot;rule&quot; value:@&quot;discos-enabled&quot;];
      NSURLQueryItem *queryItemVideoId = [NSURLQueryItem queryItemWithName:@&quot;video_id&quot; value:jsonResponse[@&quot;id&quot;]];

      //deserialize the video and store in dictionary
      [videoPropertiesDictionary addEntriesFromDictionary:jsonResponse];

      // For each source, update each VMAP URL stored in the jsonResponse NSDictionary object
      // and assemble the NSURLQueryItem. Store it in the mutable version of the jsonResponse NSDictionary object.
      for (NSDictionary *source in videoPropertiesDictionary[@&quot;sources&quot;])
      {
        NSMutableDictionary *mutableSource = [[NSMutableDictionary alloc] init];
        [mutableSource addEntriesFromDictionary:source];

        NSString *vmapURL = mutableSource[@&quot;vmap&quot;];
        components = [NSURLComponents componentsWithString:vmapURL];

        NSArray *queryItemsArray = components.queryItems;
        NSURLQueryItem *bctoken = [queryItemsArray firstObject];
        components.queryItems = @[bctoken, queryItemEntrypointUrlParameter, queryItemVideoId ];
        mutableSource[@&quot;vmap&quot;] = components.URL.absoluteString;

        [updatedSources addObject:mutableSource];
      }
      videoPropertiesDictionary[@&quot;sources&quot;] = updatedSources;
      // Create a new video object with the updated jsonResponse NSDictionary object
      BCOVVideo *video = [BCOVPlaybackService videoFromJSONDictionary:videoPropertiesDictionary];
      // Setting this video object to the BCOVPlaybackController will call the new vmap URL
      // (with the URL parameters appended) when playback starts.
      [self.controller setVideos:@[video]];
    }
    else
    {
      NSLog(@&quot;ViewController Debug - Error retrieving video playlist: `%@`&quot;, error);
    }

  }];
}

@end</code></pre>
</div>

</section>

</article>



          <!-- END DRUPAL CONTENT -->
        </div>
      </div>
      <!-- bcl scripts -->
      <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/js/foundation.min.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
      <script src="/en/scripts/docs-nav-data.min.js"></script>
      <script src="/en/scripts/bcls-doc-site-v3.js"></script>
      <script src="//learning-services-media.brightcove.com/doc-assets/js/bcls-utils.js"></script>
      <script src="//learning-services-media.brightcove.com/doc-assets/js/prism/prism.js"></script>
      <script>
      $(document).foundation();
      </script>
      <!-- Any scripts specific to page samples should go here -->
      </body>

      </html>
