<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <style>
        body {
            margin: 1em 2em;
            font-family: sans-serif;
        }

        h2 {
            font-size: 1.1em;
        }

        button {
            padding: .5em;
        }

        pre {
            background-color: #F1EFEE;
            border-left: .5em solid #636363;
            box-shadow: 5px 5px 10px rgba(192, 192, 192, 1.000);
            font-family: Hack, monospace;
            font-size: .8em;
            padding: 1em;
        }

        .video-thumbnail {
            margin: 0;
            padding: 0;
            width: 200px;
            height: 113px;
            cursor: pointer;
        }

    </style>
</head>

<body>
    <h1>Popular Videos Overlay</h1>
    <div style="display: block; position: relative; max-width: 600px;">
        <div style="display: block; padding-top: 56.25%;">
            <video id="popularVideosPlayer" data-video-id="4454620113001" data-account="1752604059001" data-player="ee7ec864-097d-4d90-a544-9ef4f5e3c7a2" data-embed="default" class="video-js" controls="" style="width: 100%; height: 100%; position: absolute; top: 0px; bottom: 0px; right: 0px; left: 0px;"></video>
            <script src="//players.brightcove.net/1752604059001/ee7ec864-097d-4d90-a544-9ef4f5e3c7a2_default/index.min.js"></script>
            <script src="//players.brightcove.net/videojs-overlay/lib/videojs-overlay.js"></script>
        </div>
    </div>
    <p>
        <strong>Analytics API request:</strong>
    </p>
    <pre id="apiRequest"></pre>
    <p>
        <strong>Analytics Response data</strong>
    </p>
    <pre id="responseData"></pre>
    <script>
        videojs("popularVideosPlayer").ready(function() {
            var player = this,
                reportURL = 'https://analytics.api.brightcove.com/v1/data',
                proxyURL = 'https://solutions.brightcove.com/bcls/bcls-proxy/doc-samples-proxy.php',
                videoIds = [],
                videoData = [],
                apiRequest = document.getElementById('apiRequest'),
                responseData = document.getElementById('responseData'),
                // get the epoch time in milliseconds 24 hours ago
                // 12 hours in milliseconds = 1000 * 24 * 60 * 60 = 86,400,000
                yesterday = new Date().valueOf() - 86400000;

                setRequestData();

                /**
                 * create an element
                 *
                 * @param  {string} type - the element type
                 * @param  {object} attributes - attributes to add to the element
                 * @return {object} the HTML element
                 */
                function createEl(type, attributes) {
                    var el;
                    if (isDefined(type)) {
                        el = document.createElement(type);
                        if (isDefined(attributes)) {
                            var attr;
                            for (attr in attributes) {
                                el.setAttribute(attr, attributes[attr]);
                            }
                        }
                        return el;
                    }
                };


                function extractVideoIds(aapiData) {
                    var i,
                        iMax = aapiData.items.length;
                    for (i = 0; i < iMax; i++) {
                        if (aapiData.items[i].video !== null) {
                            videoIds.push(aapiData.items[i].video)
                        }
                    }
                    console.log('videoIds', videoIds);
                    getVideoById();
                }

                function getVideoById() {
                    var i,
                        iMax = videoIds.length;
                    for (i = 0; i < iMax; i++) {
                        player.catalog.getVideo(videoIds[i], function(error, video) {
                            console.log('error', error)
                            videoData.push(video);
                            if (i === iMax) {
                                createVideoList();
                            }
                        });
                    }
                }

                function createVideoList() {
                    console.log(videoData);
                    var i,
                        iMax = videoData.length,
                        videoList = document.createElement();
                    for (i = 0; i < iMax; i++) {
                        videoList += '<img class="video-thumbnail" data-video-id="' + videoData[i].id + '" src="' + videoData[i].thumbnail + '">';
                    }
                    videoList += '</p>';
                    createOverlay(videoList);
                }

                function createOverlay(videoList) {
                    player.overlay({
                        overlays: [
                            {
                                align: 'top',
                                content: videoList,
                                start: 'pause',
                                end: 'play'
                            },
                            {
                                align: 'top',
                                content: videoList,
                                start: 'end',
                                end: 'play'
                            }
                        ]
                    });
                }

                /**
                 * sets up the data for the API request
                 * @param {String} id the id of the button that was clicked
                 */
                function setRequestData() {
                    var endPoint = '',
                        requestData = {};
                    // note that we don't have to set the to date to now because that's the default
                    endPoint = '?accounts=1752604059001&dimensions=video&sort=-video_view&limit=6&from=' + yesterday;
                    requestData.url = reportURL + endPoint;
                    requestData.requestType = 'GET';
                    apiRequest.textContent = requestData.url;
                    getMediaData(requestData);
                }
                /**
                 * send API request to the proxy
                 * @param  {Object} requestData options for the request
                 * @param  {String} requestID the type of request = id of the button
                 */
                function getMediaData(options, requestID) {
                    var httpRequest = new XMLHttpRequest(),
                        responseRaw,
                        parsedData,
                        requestParams,
                        dataString,
                        // response handler
                        getResponse = function() {
                            try {
                                if (httpRequest.readyState === 4) {
                                    if (httpRequest.status === 200) {
                                        if (requestID === 'formatCSV') {
                                            responseData.textContent = httpRequest.responseText;
                                        } else {
                                            console.log(httpRequest.responseText);
                                            responseRaw = httpRequest.responseText;
                                            responseData.textContent = responseRaw;
                                            parsedData = JSON.parse(responseRaw);
                                            extractVideoIds(parsedData);
                                            responseData.textContent = JSON.stringify(parsedData, null, '  ');
                                        }
                                    } else {
                                        alert('There was a problem with the request. Request returned ' + httpRequest.status);
                                    }
                                }
                            } catch (e) {
                                alert('Caught Exception: ' + e);
                            }
                        };
                    // set up request data
                    requestParams = 'url=' + encodeURIComponent(options.url) + '&requestType=' + options.requestType;
                    if (options.requestBody) {
                        dataString = JSON.stringify(options.requestBody);
                        requestParams += '&requestBody=' + encodeURIComponent(dataString);
                    }
                    console.log(requestParams);
                    // set response handler
                    httpRequest.onreadystatechange = getResponse;
                    // open the request
                    httpRequest.open('POST', proxyURL);
                    // set headers
                    httpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    // open and send request
                    httpRequest.send(requestParams);
                }




            player.catalog.getVideo(player.options()['data-video-id'], function(error, video) {
                //deal with error
                player.catalog.load(video);
            });
        });
    </script>
</body>

</html>
