<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=device-width" />
    <title id="bclPageTitle">Smart Player API Sample: Capturing Events on Replay</title>
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/foundation/5.5.0/css/foundation.min.css" />
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.0/css/normalize.css" />
    <script src="//use.edgefonts.net/source-code-pro.js"></script>
    <link href="//files.brightcove.com/proxima-nova/font-faces.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="/en/styles/bcls-doc-site.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css" />
    <link rel="stylesheet" type="text/css" href="/en/styles/anytime.5.0.0-1401232312.min.css" />
    <link rel="stylesheet" href="/en/video-cloud/smart-player-api/samples/css/api-samples.css" type="text/css">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2728311-29', 'auto');
  ga('send', 'pageview');

</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.0/js/vendor/modernizr.js"></script>
  </head>
    <body>
    <!-- header navbar -->
    <div id="navWrapper" class="fixed"></div>
	<!-- breadcrumbs -->
	<nav id="breadCrumbWrapper" class="breadcrumbs show-for-medium-up"></nav>
    <!-- search -->
    <div id="searchModal" class="reveal-modal" data-reveal></div>
    <!-- content -->
    <div class="row">
        <div class="large-2 columns show-for-large-up">
            <div id="sidenav"></div>
        </div>
        <div id="main" class="large-10 small-12 columns">
        <div id="top" class="section">
          <h1>Capturing Events on Replay</h1>
          <p class="BCL-objective">This topic describes Capturing "begin" and "complete" events when the video is replayed.</p>
          <p>The Smart Player APIs' <code>BEGIN</code> and <code>COMPLETE</code> events fire only once per video load. If the viewer replays the video, these events will not be triggered a second time. This is intentional because it is the expected behavior for many existing analytics plugins that depend on the API.</p>
            <p>If you do want to know when a video is played from the beginning or stops at the end a second time, you can use the <code>PLAY</code> and <code>STOP</code> events. The event handler functions are passed an object that includes the current media duration.</p>
          
        </div><!-- div id="top" -->
        <!--break-->
        <div id="resources" class="section">
          <h2><a name="resources"></a>API resources used</h2>
          <h3>Smart Player API</h3>
          <p>This sample uses the following API resources</p>
          <h4>Modules and methods</h4>
          <ul>
            <li>VIDEO_PLAYER
              <ul>
                <li>addEventListener()</li>
              </ul>
            </li>
          </ul>
          <h4>Events</h4>
          <ul>
            <li>onTemplateLoad</li>
            <li>onTemplateReady</li>
            <li>MediaEvent: PLAY</li>
            <li>MediaEvent: STOP</li>
          </ul>
          <p class="text-warning">Note: the read methods of the Smart Player API are available to Express 3, Professional, and Enterprise accounts.</p>
        </div><!-- div id="resources" -->

        <div id="player" class="section">
          <h2><a name="player"></a>The player</h2>
          <p>A standard Chromeless Video Player is used for this sample.</p>
          <p class="text-warning">Note: the buttons below are for development purposes only &mdash; do not use in production.</p>

          <!-- buttons to switch between HTML and Flash Players -->
          <div id="modeSwitch">
            <span class="button" id="switchToHTML5" style="margin-bottom: 20px;margin-right: 10px;">Switch to HTML5 Player</span>
            <span class="button" id="switchToFlash" style="margin-bottom: 20px;">Switch to Flash Player</span>
          </div><!-- div id="modeSwitch" -->
          <div class="player-block">
            <br/>

            <!-- Start of Brightcove Player -->

            <div style="display:none">

            </div>

            <p>Play the video, starting and stopping playback. In the event display area, you should see messages for the the <code>PLAY</code> and <code>STOP</code> events. When the video ends, replay it. Notice these events continue to work when the video is replayed.</p>

            <!-- Start of Brightcove Player -->

            <div style="display:none">
            Chromeless Smart Player with API Enabled 
            </div>

            <!--
            By use of this code snippet, I agree to the Brightcove Publisher T and C 
            found at https://accounts.brightcove.com/en/terms-and-conditions/. 
            -->

            <script language="JavaScript" type="text/javascript" src="http://admin.brightcove.com/js/BrightcoveExperiences.js"></script>

            <object id="myExperience" class="BrightcoveExperience">
                <param name="bgcolor" value="#FFFFFF" />
                <param name="width" value="480" />
                <param name="height" value="270" />
                <param name="playerID" value="661469457001" />
                <param name="playerKey" value="AQ~~,AAAABvaLqkE~,2tO1p6J5s285u0tXryGC4blOT_hdk-Ob" />
                <param name="isVid" value="true" />
                <param name="isUI" value="true" />
                <param name="dynamicStreaming" value="true" />
                <param name="@videoPlayer" value="2534277032001" />

                <!-- smart player api params -->
                <param name="includeAPI" value="true" />
                <param name="templateLoadHandler" value="onTemplateLoad" />
                <param name="templateReadyHandler" value="onTemplateReady" />

            </object>

            <!-- 
            This script tag will cause the Brightcove Players defined above it to be created as soon
            as the line is read by the browser. If you wish to have the player instantiated only after
            the rest of the HTML is processed and the page load is complete, remove the line.
            -->
            <script type="text/javascript">brightcove.createExperiences();</script>

            <!-- End of Brightcove Player -->

            <!-- display event data -->
            <h5>Event Display Area</h5>
            <div id="eventInfo" style="border:1px solid black">
                <!--event info diplay area-->
            </div>
            
          </div><!-- div class="player-block" -->
        </div><!-- div id="player" -->

        <div id="logic" class="section" >
          <h2><a name="logic"></a>How it is done</h2>
          <p>This sample uses the Smart Player API to listen for media events.</p>
          <h3>The Smart Player API part</h3>
          <p>When the video player is ready, we get a reference to the <code>VIDEO_PLAYER</code> module and use the <code>play()</code> method to start playback of the current video.</p>
          <code data-gist-id="7457328" data-gist-hide-footer="true" data-gist-line="57-64"></code><br/>
          <p>Then the <code>addEventListener()</code> method is called to listen for the <code>brightcove.api.events.MediaEvent.PROGRESS</code> event.</p>
          <code data-gist-id="7457328" data-gist-hide-footer="true" data-gist-line="70"></code><br/>
          <p>The <code>PROGRESS</code> event returns an object that contains the video duration and current position. It is dispatched approximately 4-5 times a second. So, in the <code>onProgress()</code> event handler, we can check the video's position relative to its duration. You don't want to wait until the values are equal because the video will stop. Instead, we can use a conditional statement to check when the position is close to the end (.25 seconds from completion) and use the <code>seek()</code> method to return to the beginning of the video.</p>
          <code data-gist-id="7457328" data-gist-hide-footer="true" data-gist-line="74-78"></code>
          <p class="BCL-aside">In rare instances the value of <code>.25</code> will not catch the end of the video. If you experience this, use the following as your condition <code>if (evt.position > ((evt.media.length/1000)-0.1)){</code>.</p>
          <h3>Looping videos on iOS and Android devices</h3>
          <p>When attempting to make a video loop on iOS and Android devices, you will find that the <code>PROGRESS</code> event introduces some unexpected behavior to the video player. To work around these issues, you must first check to see if the user is browsing on an iOS or Android device. Create two variables, one for Android and one for iOS, that sets the <code>userAgent</code> property to match their respective platforms. </p>
          <code data-gist-id="7457328" data-gist-hide-footer="true" data-gist-line="54-55"></code><br/>
          <p>Next, when the video player is ready, use a conditional statement to check if the user is on an iOS or Android device. If they are, listen for the <code>STOP</code> event. Otherwise, listen for the <code>PROGRESS</code> event.</p>
          <code data-gist-id="7457328" data-gist-hide-footer="true" data-gist-line="66-71"></code><br/>
          <p>When the video ends, the <code>onStop()</code> event handler fires and the <code>play()</code> method is called to restart playback of the video.</p>
          <code data-gist-id="7457328" data-gist-hide-footer="true" data-gist-line="80-82"></code><br/>
          <p class="text-warning">Note: The STOP event is dispatched when playback of a video is paused or when a video has ended. In the case of this example, selecting the Pause button on your mobile device will not result in the video pausing.</p>          
          
          <h3>Using the COMPLETE event</h3>
          <p>Rather than using the <code>PROGRESS</code> and <code>STOP</code> events to loop videos on desktop and mobile devices, listening for the <code>COMPLETE</code> event and then calling the <code>play()</code> method may seem like an easier solution. However, that doesn't quite work because the <code>COMPLETE</code> event only fires on the video's initial playback. As a result, the video will only replay once. In addition, the milliseconds it takes for the event to fire and the <code>play()</code> method to execute results in a flash of a black video screen between the plays.</p>
        </div><!-- div id="logic" -->

        <div id="code" class="section">
          <h2><a name="code"></a>The code</h2>
          <p>See the full code sample <a href="https://gist.github.com/bcls/7457328">here</a>.</p>
          <h3>Modifications made to the player publishing code</h3>
          <code data-gist-id="7457328" data-gist-hide-footer="true" data-gist-line="34-37"></code>
          <h3>JavaScript used for this sample</h3>
          <code data-gist-id="7457328" data-gist-hide-footer="true" data-gist-line="50-84"></code>
        </div><!-- div id="code" -->

      </div><!-- div id="main" -->
    </div><!-- <div class="row"> -->
    <!-- bcl scripts============================================================-->
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/gist-embed/1.9/gist-embed.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.3/fastclick.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.0/js/foundation.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script src="/en/scripts/docs-nav-data.min.js"></script>
    <script src="/en/scripts/bcls-doc-site.js"></script>
    <script src="/en/scripts/flashHTMLswitch-nojQ.js"></script>
    <script>
        $(document).foundation();
    </script>
        
    <script id="pageScript" type="text/javascript">
      /******** Any scripts specific to page samples should go here *********/
            
        var player, 
            APIModules,
            videoPlayer,
            isAndroid = (/android/i).test(navigator.userAgent),
            androidVersion = (navigator.userAgent.match(/\bAndroid (\d+\.\d+)/)||[])[1],
            eventData = document.getElementById("eventInfo"),
            eventStr = "";

        // utility
        function logit(context, message) {
            eventStr += context + message + "<br/>";
            eventData.innerHTML = eventStr ;
        };

        function onTemplateLoad(experienceID){
            logit("onTemplateLoad", "");
            player = brightcove.api.getExperience(experienceID);
            APIModules = brightcove.api.modules.APIModules;
        }

        function onTemplateReady(e){
            logit("onTemplateReady", "");
            videoPlayer = player.getModule(APIModules.VIDEO_PLAYER);
            videoPlayer.addEventListener(brightcove.api.events.MediaEvent.PLAY, onPlay);
            videoPlayer.addEventListener(brightcove.api.events.MediaEvent.STOP, onStop);
        }

        function onPlay(e) {
            // Event handler for BCMedia.PLAY
            if (e.position == 0) {
                // Playing from beginning
                logit("onPlay : ", "PLAY_FROM_BEGINNING");
            } else {
                // A play at some other point, e.g. resume from pause
                logit("onPlay : ", "PLAY");
            }
        }

        function onStop(e) {
            // Event handler for BCMedia.STOP
            if (e.position > ((e.media.length/1000)-0.1)) {
                // Stopped is at the end, consider it a pseudo-complete
                logit("onStop : ", "STOP_AT_END");
            } else if (e.position == 0 && isAndroid && +androidVersion >= 4.3) {
                // On Android 4.3, the stop at the end will have the media position 0
                logit("onStop : ", "STOP_AT_END");
            } else {
                // A stop at some other point, e.g. paused
                logit("onStop : ", "STOP");
            }
        }

     </script>

      <div class="footer text-center"><a id="feedbackMail" href="mailto:docs@brightcove.com">Questions or comments?</a></div>
    <script>
	var feedbackMail = document.getElementById("feedbackMail");
	feedbackMail.setAttribute("href", "mailto:docs@brightcove.com?subject=question regarding " + encodeURI(document.location.href));
	</script>
	</body>
</html>